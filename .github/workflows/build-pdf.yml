name: Build PDFs

on:
  push:
    paths:
      - '**/*.md'
      - 'asset/**'
      - 'template/**'
      - '!**/README.md'
      - '!PDF/**'
      - '!.github/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pdf:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      COMMIT_NAME: ${{ vars.GIT_AUTHOR_NAME || github.actor }}
      COMMIT_EMAIL: ${{ vars.GIT_AUTHOR_EMAIL || format('{0}@users.noreply.github.com', github.actor) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache TinyTeX
        id: tinytex-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.TinyTeX
            ~/.texlive
          key: ${{ runner.os }}-tinytex-v1
          restore-keys: |
            ${{ runner.os }}-tinytex-

      - name: Detect TinyTeX
        id: tinytex-present
        run: |
          if [ -d "$HOME/.TinyTeX/bin" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install TinyTeX
        if: steps.tinytex-present.outputs.present != 'true'
        uses: r-lib/actions/setup-tinytex@v2

      - name: Add TinyTeX to PATH
        run: |
          set -euo pipefail
          TEXBIN=$(find "$HOME/.TinyTeX/bin" -maxdepth 1 -type d -name '*-linux' -print -quit)
          if [ -n "$TEXBIN" ]; then
            echo "$TEXBIN" >> "$GITHUB_PATH"
          fi

      - name: Install TeX packages for template
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-liberation fonts-dejavu
          tlmgr install \
            collection-latexrecommended \
            collection-latexextra \
            collection-fontsrecommended \
            collection-xetex \
            dejavu
      - name: Export changed markdown to PDF
        run: |
          set -euo pipefail
          mkdir -p PDF

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -n "$BEFORE" ] && git cat-file -e "$BEFORE^{commit}" 2>/dev/null; then
            # Remove PDFs for deleted markdown files
            DELETED=$(git diff --name-only --diff-filter=D "$BEFORE" "$AFTER" -- '*.md' ':!**/README.md' ':!PDF/**' ':!.github/**')
            if [ -n "$DELETED" ]; then
              while IFS= read -r file; do
                rel="${file%.md}.pdf"
                out="PDF/$rel"
                [ -f "$out" ] && rm -f "$out"
              done <<< "$DELETED"
            fi

            CHANGED=$(git diff --name-only "$BEFORE" "$AFTER" -- '*.md' ':!**/README.md' ':!PDF/**' ':!.github/**')
          else
            # Fallback for force-push or manual runs: rebuild all markdown
            CHANGED=$(git ls-files '*.md' ':!**/README.md' ':!PDF/**' ':!.github/**')
          fi
          if [ -z "$CHANGED" ]; then
            echo "No markdown changes"
            exit 0
          fi

          while IFS= read -r file; do
            [ -f "$file" ] || continue
            rel="${file%.md}.pdf"
            out="PDF/$rel"
            mkdir -p "$(dirname "$out")"
            pandoc "$file" -o "$out" --defaults=.pandoc/defaults.yaml
          done <<< "$CHANGED"

      - name: Commit PDFs
        run: |
          if git status --porcelain | grep -q 'PDF/'; then
            git add PDF
            git config user.name "$COMMIT_NAME"
            git config user.email "$COMMIT_EMAIL"
            git commit -m "chore(pdf): update generated PDFs [skip ci]"
            git push
          else
            echo "No PDF changes to commit"
          fi
